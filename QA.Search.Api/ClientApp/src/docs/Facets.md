## Фасетный поиск

Задать фасеты по различным полям можно с помощью поля `$facets`.

Например, интервал для даты публикации и 5 наиболее популярных рубрик:

```json
{
  "$from": "qp.news",
  "$facets": {
    "PublishDate": "$interval",
    "Rubrics": { "Title": { "$samples": 5 } }
  }
}
```

В результате будет получен объект со значениями фасетов:

```json
{
  "status": 200,
  // ...
  "facets": {
    "PublishDate": {
      "interval": { "from": "1999-05-05T00:00:00", "to": "2019-07-09T17:18:00" }
    },
    "Rubrics.Title": {
      "samples": [
        { "value": "Домашний Интернет и ТВ", "count": 8649 },
        { "value": "Спецпредложения", "count": 4495 },
        { "value": "Услуги мобильной связи", "count": 4077 },
        { "value": "Тарифы и скидки на звонки", "count": 4031 },
        { "value": "Обслуживание абонентов", "count": 3597 }
      ]
    }
  }
}
```

Поля вложенных объектов можно объявлять как через точку, так и во вложенной форме.
Но в результатах названия фасетов будут всегда представлять собой полные пути
к вложенному полю через точку.

Фасеты строятся вместе с выполнением поиска и фильтрации по всему диапазону найденных документов.
Таким образом, диапазон построения фасетов ограничивается строкой запроса `$query` и фильтром `$where`.
Если при выполнении запроса нам нужны только фасеты (а не найденные документы), то мы можем установить
поле `$limit: 0`.

```json
{
  "$from": "qp.news",
  "$where": {
    "Regions": { "Alias": ["moskva", "spb"] }
  },
  "$limit": 0,
  "$facets": {
    // ...
  }
}
```

Доступны четыре типа фасетов: **Interval**, **Samples**, **Ranges** и **Percentiles**. Результатом
построения каждого фасета является объект с одним полем, где имя поля это тип фасета,
а значение это результаты.

### Interval Facet

Interval Facet служит для определения минимального и максимального значения поля в выборке.
Задается с помощью ключевого слова: `"$interval"`:

```json
{
  "$from": "qp.news",
  "$facets": {
    "PublishDate": "$interval"
  }
}
```

Результатом является объект с полями `from` и `to`:

```json
{
  "facets": {
    "PublishDate": {
      "interval": { "from": "1999-05-05T00:00:00", "to": "2019-07-09T17:18:00" }
    }
  }
}
```

### Samples Facet

Samples Facet служит для нахождения наиболее популярных значений поля в выборке.
Задается как объект `{ "$samples": <count> }`, где `<count>` — максимальное количество популярных значений.
Или в сокращенной форме, как ключевое слово `"$samples"` (тогда `<count>` = 100).

```json
{
  "$from": "qp.news",
  "$facets": {
    "Rubrics.Title": { "$samples": 2 }
  }
}
```

Результатом является массив объектов с полями `value` — значение поля
и `count` — кол-во документов, соответствующее этому значению:

```json
{
  "facets": {
    "Rubrics.Title": {
      "samples": [
        { "value": "Домашний Интернет и ТВ", "count": 8649 },
        { "value": "Спецпредложения", "count": 4495 }
      ]
    }
  }
}
```

Если мы ищем сразу по нескольким индексам, можно построить фасет по спец. полю `_index`:

```json
{
  "$from": "media.*",
  "$facets": {
    "_index": "$samples"
  }
}
```

В результате мы получим распределение документов по индексам:

```json
{
  "facets": {
    "_index": {
      "samples": [
        { "value": "media.materials", "count": 2115 },
        { "value": "media.menuandpages", "count": 35 }
      ]
    }
  }
}
```

### Ranges Facet

Ranges Facet позволяет разбить значения поля на именованные диапазоны.
Задается как объект, содержащий список диапазонов:

```json
{
  "$ranges": [
    { "$name": "<range_name>", "$from": "<min_value>", "$to": "<max_value>" }
    // ...
  ]
}
```

Где `$name` — имя диапазона, `$from` — нижняя граница (включая указанное значение),
`to` — верхняя граница (не включая указанное значение).

Например:

```json
{
  "$from": "dpc.internettariff",
  "$facets": {
    "ParametersByAlias.MaxSpeed.NumValue": {
      "$ranges": [
        { "$name": "high", "$from": 101 },
        { "$name": "mid", "$from": 30, "$to": 101 },
        { "$name": "low", "$to": 30 }
      ]
    }
  }
}
```

Результатом является массив объектов с полями `name` — имя диапазона, `from`, `to` —
границы диапазона и `count` — кол-во документов, попавшее в диапазон:

```json
{
  "facets": {
    "ParametersByAlias.MaxSpeed.NumValue": {
      "ranges": [
        { "name": "low", "to": 30, "count": 99 },
        { "name": "mid", "from": 30, "to": 101, "count": 165 },
        { "name": "high", "from": 101, "count": 11 }
      ]
    }
  }
}
```

### Percentiles Facet

Percentiles Facet служит для построения доверительных интервалов и медианных значений.
Задается как объект `{ "$percentiles": number[] }`;, содержащий список процентных значений.

Например, доверительный интервал 5-95 %:

```json
{
  "$from": "dpc.device",
  "$limit": 0,
  "$facets": {
    "ParametersByAlias.SalePrice.NumValue": {
      "$percentiles": [5, 95]
    }
  }
}
```

Результатом является массив объектов с полями `percent` — процент распределения вероятностей
и `value` — соответствующее значение поля:

```json
{
  "facets": {
    "ParametersByAlias.SalePrice.NumValue": {
      "percentiles": [
        { "percent": 5, "value": 1300 },
        { "percent": 95, "value": 6500 }
      ]
    }
  }
}
```

Другие примеры Percentiles Facet:

- `{ "$percentiles": [50] }` — медиана
- `{ "$percentiles": [0, 100] }` — минимум и максимум
- `{ "$percentiles": [90, 99, 99.9, 99.99] }` — уровни доверия в процентах
