## Дополнение поискового запроса

Дополнение осуществляется с помощью следующих endpoint-ов:

- **`POST /api/v1/completion`** — дополнение по одному или нескольким индексам Elastic. Принимает единственный JSON-объект запроса `CompletionRequest`. Возвращает JSON-объект `CompletionResponse`.

- **`POST /api/v1/multi_completion`** — мультиплексирование нескольких независимых запросов. Принимает массив JSON-объектов `CompletionRequest[]`. Возвращает объект массив JSON-объектов `CompletionResponse[]` той же длины, что и массив запросов. Запросы и ответы сопоставляются по порядковому номеру в массиве.

Для получения набора дополненных фраз, нужно указать один или несколько индексов в поле `$from`
и поисковый ввод пользователя в поле `$query`:

```json
{
  "$from": ["qp.news", "qp.textpages"],
  "$query": "москва",
  "$weights": {
    // ...
  }
}
```

Допустимы полные имена индексов или wildcard-паттерны.

Искать можно только по полям, проиндексированным как текст.

В результате будут возвращены несколько предлагаемых фраз:

```json
{
  "status": 200,
  "phrases": ["москва", "москва и область"]
}
```

#### Веса полей

При этом __необходимо__ указать веса полей документа, по которым будет строиться дополнение, в поле `$weights`:

```json
{
  "$from": "media.materials",
  "$query": "москва",
  "$weights": {
    "HeaderTitle": 5,
    "MainTag.Title": 10,
    "Tags": { "Title": 2 }
  }
}
```

Поля вложенных объектов можно объявлять как через точку, так и во вложенной форме.

Если конкретные значения весов не важны, а важны только сами поля, можно просто указать все веса равными `1`:

```json
{
  "$from": "media.materials",
  "$query": "москва",
  "$weights": {
    "HeaderTitle": 1,
    "MainTag.Title": 1,
    "Tags.Title": 1
  }
}
```
#### Роли пользователя

Если в проекте присутствют роли пользователей и включена индексация полей, а так же в конфигурации проекта API включена поддержка ролей, то можно добавить роль или список ролей через параметр `$roles` (массив).  
На стороне API будет произведена выборка разрешенных индексов куда можно делать запросы с указанной ролью/ролями, после чего содержимое `$from` будет заменено на список доступных индексов.  
При указании роли/ролей можно в `$from` использовать `*`, оно всё равно будет заменено на полученный в результате проверки набор индексов.  
Пример запроса:

```json
{
  "$from": "media.materials",
  "$query": "москва",
  "$roles": ["Manager", "Reader"],
  "$weights": {
    "HeaderTitle": 5,
    "MainTag.Title": 10,
    "Tags": { "Title": 2 }
  }
}
```
