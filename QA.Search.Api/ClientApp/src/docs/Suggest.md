## Поиск по префиксам слов

Поиск осуществляется с помощью следующих endpoint-ов:

- **`POST /api/v1/suggest`** — полнотекстовый поиск по одному или нескольким индексам Elastic. Принимает единственный JSON-объект запроса `SuggestRequest`. Возвращает JSON-объект `SuggestResponse`.

- **`POST /api/v1/multi_suggest`** — мультиплексирование нескольких независимых поисковых запросов. Принимает массив JSON-объектов `SuggestRequest[]`. Возвращает объект массив JSON-объектов `SuggestResponse[]` той же длины, что и массив запросов. Запросы и ответы сопоставляются по порядковому номеру в массиве.

Для получения набора документов, нужно указать один или несколько индексов в поле `$from`
и поисковый ввод пользователя в поле `$query`:

```json
{
  "$from": ["qp.news", "qp.textpages"],
  "$query": "абон"
}
```

Допустимы полные имена индексов или wildcard-паттерны.

При выполнении запроса используются морфология и префиксы слов.
Искать можно только по полям, проиндексированным как текст.

В результате будет возвращен массив документов:

```json
{
  "status": 200,
  "totalCount": 110,
  "documents": [
    {
      "_id": "12345",
      "_index": "qp.textpages",
      "Title": "Помощь абоненту",
      // ...
    },
    // ...
  ]
}
```

#### Веса полей

При этом можно указать веса различных полей документа в поле `$weights`:

```json
{
  "$from": "media.materials",
  "$query": "абон",
  "$weights": {
    "HeaderTitle": 5,
    "MainTag.Title": 10,
    "Tags": { "Title": 2 }
  }
}
```

Поля вложенных объектов можно объявлять как через точку, так и во вложенной форме.

#### Минимальное кол-во найденных слов

С помощью поля `$requiredWordsCount` можно указать минимальное количество найденных слов из `$query`, при котором документ попадает в выдачу. По-умолчанию необходимы ВСЕ слова. Например:

- `3` — должны быть найдены не менее трех слова
- `-1` — должны быть найдены все слова кроме одного
- `"80%"` — должны быть найдены не менее 80% слов

### Выбор полей

Каждый возвращаемый документ содержит служебные поля:

- `_id: string` — Строковый идентификатор документа в Elastic
- `_index: string` — Сокращенное имя индекса, которому принадлежит документ
- `_score: number` — Мера релевантности документа в рамках запроса

Остальные поля можно выбрать с помощью поля `$select` (по-умолчанию возвращаются все поля):

```json
{
  "$from": "media.materials",
  "$select": ["Id", "Content", "Tags.Title", "Category.*"]
}
```

Допустимы имена полей вложенных объектов через точку или wildcard-паттерны.

### Подсвеченные HTML-фрагменты

С помощью поля `$snippets` можно указать, по каким полям документа нужно сгенерировать подсвеченные сниппеты, где `$count` — количество сниппетов (default 5), а `$length` — максимальная длина (default 100):

```json
{
  "$from": "media.materials",
  "$query": "абон",
  "$snippets": {
    "HeaderTitle": { "$count": 1, "$length": 100 },
    "Tags": { "Title": { "$count": 2, "$length": 50 } }
  }
}
```

Поля вложенных объектов можно объявлять как через точку, так и во вложенной форме.

В результате полученные сниппеты будут добавлены в каждый документ в спец. поле `_snippets`:

```json
{
  // ...
  "documents": [
    {
      "_id": "101391",
      "_snippets": { "HeaderTitle": ["звонки <b>абоненту</b>"] }
    }
    // ...
  ]
}
```

Также можно указать `$count` в сокращенной форме, в виде числа:

```json
{
  "$from": "media.materials",
  "$query": "абон",
  "$snippets": { "HeaderTitle": 1, "Tags": 2 }
}
```

Можно не указывать конкретного поля для сниппетов,

```json
{
  "$from": "media.materials",
  "$query": "абон",
  "$snippets": { "$count": 1, "$length": 100 }
}
```

Тогда они будут построены по объединению полей `_all`:

```json
{
  // ...
  "documents": [
    {
      "_id": "101391",
      "_snippets": { "_all": ["звонки <b>абоненту</b>"] }
    }
    // ...
  ]
}
```

Для того, чтобы поле не разбивалось на несколько сниппетов, нужно задать `$count: 0`:

```json
{
  "$from": "media.materials",
  "$query": "абон",
  "$snippets": { "HeaderTitle": { "$count": 0 } }
}
```

Тогда сниппет будет построен по всему полю целиком.

### Сортировка

Сортировка результатов задается в поле `$orderBy`:

- в виде имени поля `"PublishDate"`
- объекта с указанием направления сортировки `{ "PublishDate": "desc" }`
- или набора из нескольких полей: `["Id", { "PublishDate": "desc" }]`

Также можно сортировать по спец. полю `_score`, которое соответствует релевантности документа

```json
{
  "$from": "media.materials",
  "$query": "абон",
  "$orderBy": [{ "PublishDate": "desc" }, "_score"]
}
```

По-умолчанию выдача сортируется по `_score`

### Размер выдачи

Ограничить размер выдачи можно с помощью полей `$limit` — размер страницы (по-умолчанию 50):

```json
{
  "$from": "media.materials",
  "$limit": 10
}
```

### Роли пользователя

Если в проекте присутствют роли пользователей и включена индексация полей, а так же в конфигурации проекта API включена поддержка ролей, то можно добавить роль или список ролей через параметр `$roles` (массив).  
На стороне API будет произведена выборка разрешенных индексов куда можно делать запросы с указанной ролью/ролями, после чего содержимое `$from` будет заменено на список доступных индексов.  
При указании роли/ролей можно в `$from` использовать `*`, оно всё равно будет заменено на полученный в результате проверки набор индексов.  
Пример запроса:

```json
{
  "$from": ["qp.news", "qp.textpages"],
  "$query": "абон",
  "$roles": ["Manager", "Reader"]
}
```
