### Контекстные поля

Поле документа является контекстным, если при разных условиях фильтрации для
одного и того же документа Elastic необходимо выдавать разные значения этого поля.

Запрос для поиска документов также имеет поле `$context`, в котором указан фильтр для
контекстных полей документа. Если этот фильтр явно отсутствует, его значение берется из поля `$where`.

**Пример:** поле `"SearchUrl"`, содержащее Url страницы, который начинается с поддомена.
Поддомен в свою очередь зависит от одного из регионов документа, хранящихся в массиве `"Regions"`.

Для этого при индексации в контекстное поле добавляется массив объектов, каждый из которых
содержит единственное значение контекстного поля, а также выбранные значения тех
полей документа, по которым должна проходить контекстная фильтрация.

**Пример:**

```json
{
  "SearchUrl": [
    {
      "SearchUrl": "http://moskva.domain.ru",
      "Regions": { "Id": 123, "Alias": "moskva" }
    },
    {
      "SearchUrl": "http://spb.domain.ru",
      "Regions": { "Id": 456, "Alias": "spb" }
    }
  ],
  "Regions": [{ "Id": 123, "Alias": "moskva" }, { "Id": 456, "Alias": "spb" }]
  // ... other fields
}
```

Таким образом, в каждом объекте контекстного массива **ОБЯЗАТЕЛЬНО** содержится поле с тем же названием,
что и у исходного контекстного поля, плюс поля документа, от которых она зависит.

Далее, для всех имен полей из фильтра `$context` или `$where`, если такое поле
содержится в объектах контекстного массива, то по этому полю применяется фильтрация
на application-сервере, после загрузки документа из Elastic.

Если в фильтре не указано ни одного подходящего поля, то будет выбран первый попавшийся объект контекстного массива.

**Пример:** если в фильтре указано

```json
{
  "$where": {
    "Regions.Alias": "moskva",
    "Tags": ["foo", "bar"]
  }
}
```

То фильтрация будет производиться только по `"Regions.Alias"`, т.к. `"Tags"` не содержится в контекстных объектах.

После нахождения единственного контекстного объекта из него выбирается значение контекстного поля.

**Результат:**

```json
{
  "SearchUrl": "http://moskva.domain.ru",
  "Regions": [{ "Id": 123, "Alias": "moskva" }, { "Id": 456, "Alias": "spb" }]
  // ... other fields
}
```

Контекстная фильтрация полей поддерживает все выражения кроме булевских комбинаторов `$every`, `$some`, `$not`.
Эти комбинаторы **будут проигнорированы** при поиске значения контекстного поля.
